## 고가용성 및 확장성

### 확장성

- 애플리케이션 시스템이 조정을 통해 많은 양을 처리할 수 있다는 의미
- 수직 확장성
  - 인스턴스의 크기를 확장 (t2.micro에서 t2.large로 확장)
  - 데이터베이스와 같이 분산되지 않은 시스템에서 흔히 사용된다.
    - RDS, ElastiCache 등
  - 확장의 한계가 있음
  - 스케일 업, 스케일 다운
- 수평 확장성
  - 인스턴스나 시스템의 수를 늘림
  - 분배 시스템이 있다는 것을 의미
  - 스케일 인 (수 감소), 스케일 아웃 (수 증가)

<br>

### 고가용성

- 애플리케이션 또는 시스템을 적어도 둘 이상의 가용 영역이나 데이터 센터에서 가동 중이라는 걸 의미
- 데이터센터에서의 손실에서 살아남는 것을 목적으로 함
  - 센터 하나가 멈춰도 계속 작동이 가능하도록 하는 것

<br>
<br>

## ELB (Elastic Load Balancing) 개요

### 로드 밸런서

- 트래픽을 백엔드나 다운스트림 EC2 인스턴스 또는 서버들로 전달하는 역할
  - 부하를 다수의 다운스트림 인스턴스로 분산하기 위해 사용

<br>

### ELB (Elastic Load Balancing)

- 관리형 서비스로 AWS가 업그레이드와 유지 관리 및 고가용성을 책임진다.
- 자체 로드 밸런서를 마련하는 것 보다 저렴하다.

<br>

### 로드 밸런서의 종류

- 클래식 로드 밸런서(CLB, 2009년 출시)
  - HTTP, HTTPS, TCP, SSL, secure TCP를 지원
  - AWS는 이 로드 밸런서를 사용하는 것을 권장하지 않음
- 애플리케이션 로드 밸런서(ALB, 2016년 출시)
  - HTTP, HTTPS, WebSocket 프로토콜을 지원
- 네트워크 로드 밸런서(NLB, 2017년 출시)
  - TCP, TLS, secure TCP, UDP 프로토콜을 지원
- 게이트웨이 로드 밸런서(GWLB, 2020년 출시)
  - 네트워크층에서 작동하므로 3계층과 IP 프로토콜에서 작동

<br>

### 로드 밸런서 보안 그룹

- 사용자는 HTTP나 HTTPS를 사용해 어디서든 로드 밸런서에 접근 가능
  - 사용자와 로드 밸런서 사이의 보안그룹은 0.0.0.0/0 (어디든 가능)
- EC2 인스턴스는 로드 밸런서를 통해 곧장 들어오는 트래픽만을 허용해야 한다.
  - 포트 80에서 HTTP 트래픽을 허용하며, 소스는 IP 범위가 아니라 보안 그룹이어야 한다.
    - EC2 인스턴스의 보안 그룹과 로드 밸런서의 보안 그룹을 연결
      - 로드 밸런서에서 온 트래픽만을 허용하게 됨

<br>
<br>

## ALB (Application Load Balancing) 개요

- 7계층(HTTP) 전용 로드 밸런서
- 머신 간 다수 HTTP 애플리케이션의 라우팅에 사용
- 동일 EC2 인스턴스 상의 여러 애플리케이션에 부하를 분산
- 컨테이너와 ECS를 사용
- HTTP/2, WebSocket를 지원
- 리다이렉트도 지원하므로 HTTP에서 HTTPS로 트래픽을 자동 리다이렉트하려는 경우 로드 밸런서 레벨에서 가능
- 경로 라우팅도 지원
  - URL 대상 경로에 기반한 라우팅
    - example.com/users나 example.com/posts같은 경우, /users와 /posts는 URL 상의 서로 다른 경로이고 이들을 다른 대상 그룹에 리다이렉트 할 수 있다.
  - URL 호스트 이름에 기반한 라우팅
    - one.example.com 또는 other.example.com에 접근이 가능하다고 하면, 두 개의 다른 대상 그룹에 라우팅이 될 수 있다.
  - 쿼리 문자열과 헤더에 기반한 라우팅도 가능
- 마이크로서비스나 컨테이너 기반 애플리케이션에 가장 좋은 로드 밸런서 (Docker & Amazon ECS)
  - 포트 매핑 기능이 있어서 ECS 인스턴스의 동적 포트로의 리다이렉션을 가능하게 해줌

<br>

### 대상그룹

- AGS로 관리되는 EC2 인스턴스
- ECS 작업
- 람다 함수
- 프라이빗 IP 주소

<br>

### 알아두면 좋을 내용

- ALB를 사용하는 경우에는 고정 호스트 이름이 부여된다.
- 애플리케이션 서버는 클라이언트의 IP를 직접 보지 못하며, 클라이언트의 실제 IP는 X-Forworded-For라고 불리는 헤더에 삽입된다.
  - X-Forwarded-Port를 사용하는 포트와 X-Forwarded-Proto에 의해 사용되는 프로토콜도 얻는다.

<br>
<br>

## NLB (Network Load Balancing) 개요

- 4계층 로드 밸런서이므로 TCP와 UDP 트래픽을 다룰 수 있다.
- 성능이 매우 높다
  - 초당 수백만 건의 요청을 처리할 수 있다.
    - ALB에 비해 지연시간이 짧다.
    - ALB : 400ms
    - NLB : 100ms
- 가용 영역별로 하나의 고정 IP를 가진다.
- 탄력적 IP 주소를 각 가용 영역에 할당할 수 있다.
  - 여러개의 고정 IP를 가진 애플리케이션을 노출할 때 유용하다

<br>

### 대상그룹

- EC2 인스턴스
- 프라이빗 IP 주소
- 애플리케이션 로드 밸런서

<br>
<br>

## GWLB (Gateway Load Balancing) 개요

- 배포 및 확장과 AWS의 타사 네트워크 가상 어플라이언스의 플릿 관리에 사용된다.
- 네트워크의 모든 트래픽이 방화벽을 통과하거나 침입 탐지 및 방지 시스템에 사용된다.
- 일부 페이로드는 네트워크 수준에서 수정 가능하다.

<br>

### 대상그룹

- EC2 인스턴스
- 타사의 어플라이언스
- 프라이빗 IP 주소

<br>
<br>

## 고정 세션 (세션 밀접성, 스티키 세션)

- 클라이언트가 백엔드로 동일한 인스턴스만 통신하도록 하는 것
- 사용자가 웹 애플리케이션에 로그인하고 로그인 세션을 유지하는 데 필요한 기능
- 쿠키를 이용한 방식
  - 쿠키가 만료되면 클라이언트가 다른 인스턴스와 연결된다.
- 부하의 불균형을 초래할 수 있다.

<br>

### 쿠키의 종류

- 애플리케이션 기반 쿠키
  - 대상으로 생성된 사용자 정의 쿠키
  - 애플리케이션에 생성된다.
  - 애플리케이션에 필요한 모든 사용자 정의 속성을 포함한다.
  - 애플리케이션에서 기간을 지정할 수 있다.
- 기간 기반 쿠키
  - 로드 밸런서에서 생성되는 쿠키
  - 특정 기간을 기반으로 만료되며, 그 기간이 로드 밸런서 자체에서 생성된다.

<br>
<br>

## 크로스존 로드 밸런싱 (교차영역)

- 크로스존 로드 밸런싱을 사용하면, 모든 가용 영역에 있는 인스턴스에 트래픽을 고르게 분배된다.
- ALB는 크로스존 로드 밸런싱이 기본으로 활성화되어 있다.
- NLB와 GWLB는 크로스존 로드 밸런싱이 기본적으로 비활성화되어 있다.
  - 활성화하려면 비용을 지불해야 한다.

<br>
<br>

## SSL/TLS 인증서

- SSL인증서는 클라이언트와 로드 밸런서 사이에서 트래픽이 이동하는 동안 암호화해준다.
  - 전송 중 암호화
- SSL은 ‘보안 소켓 계층’을 의미하고, 연결을 암호화하는데 사용한다.
- TLS는 새로운 버전의 SSL로, ‘전송 계층 보안’을 의미한다.
- 공공 SSL은 인증기관(CA)에서 발급한다.
- SSL 인증서에는 만료 날짜가 있어서 주기적으로 갱신해야한다.
- 로드 밸런서는 X.509 인증서(SSL/TLS 서버 인증서)를 사용한다.
- AWS에는 인증서들을 관리할 수 있는 ACM(AWS 인증서 관리자)가 있다.

<br>

### SNI (Server Name Indication)

- 여러 개의 SSL 인증서를 하나의 웹 서버에 로드해 하나의 웹 서버가 여러 웹 사이트를 지원할 수 있도록 해준다.
- 최초 SSL 핸드세이크 단계
- ALB, NLB, CloudFront에서만 동작한다.

<br>
<br>

## 연결 드레이닝(등록 취소 지연)

- 인스턴스가 등록 취소, 혹은 비정상인 상태에 있을 때 인스턴스에 어느 정도의 시간을 주어 인-플라이트 요청(활성 요청)을 완료할 수 있도록 하는 기능
- 인스턴스가 드레이닝되면 ELB는 등록 취소 중인 인스턴스로 새로운 요청을 보내지 않는다.

<br>
<br>

## Auto Scaling Group(ASG)

- 증가한 로드에 맞춰 인스턴스를 추가하거나, 감소한 로드에 맞춰 인스턴스를 제거하는 것이 목적
- 최소, 최대 개수를 보장하기 위해 매개변수를 전반적으로 정의할 수 있다.
- 로드 밸런서와 페어링하는 경우 ASG에 속한 모든 인스턴스가 로드 밸런서에 연결된다.
- 인스턴스 속성을 기반으로 ASG를 생성하려면 시작 템플릿을 생성해야 한다.
  - 시작 템플릿에 있는 정보
    - AMI, 인스턴스 유형
    - EC2 사용자 데이터
    - EBS 볼륨
    - 보안 그룹
    - SSH 키페어
    - 인스턴스의 IAM 역할
    - 네트워크 및 서브넷 정보
    - 로드 밸런스 정보
- CloudWatch 경보를 기반으로 ASG를 스케일 인, 스케일 아웃 할 수 있다.

<br>
<br>

## 조정 정책

### 동적 스케일링 정책

- 대상 추적 스케일링
  - 가장 단순하고, 설정하기 쉽다
  - 기본 기준선을 세우고 상시 가용이 가능하도록 한다
    - 평균 CPU 사용률을 추적하여 이 수치가 40%대에 머무를 수 있도록 한다
- 단순, 단계 스케일링
  - 단계별로 스케일링을 다르게 설정한다
    - CloudWatch의 경보에 따른 단계를 설정
- 예약된 작업
  - 사용 패턴을 바탕으로 스케일링을 예상한다
    - 금요일 오후 5시마다 스케일 인 한다.

<br>

### 예측 스케일링 정책

- 예측 스케일링을 통해서 AWS 내 오토 스케일링 서비스를 활용하여 지속적으로 예측을 생성할 수 있다

<br>

### 스케일링 기반 지표

- CPU 사용률
- 대상별 요청의 수
- 평균 네트워크 입출력량

<br>

### 스케일링 휴지(Cooldown)

- 스케일링 작업이 끝날 때마다 기본적으로 5분 혹은 300초의 휴지 기간을 갖는 것
- 휴지 기간에는 ASG가 추가적으로 인스턴스를 실행, 종료할 수 없다
